<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <link rel="stylesheet" href="/static/css/ws-test.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="ws-container">
        <div class="ws-card">
            <div class="ws-header">
                <h1>WebSocket Test</h1>
                <div class="ws-status-badge">
                    <span class="ws-status-dot" id="statusDot"></span>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>
            <div class="ws-body">
                <div class="ws-controls">
                    <button class="ws-btn-primary" onclick="connect()" id="connectBtn">Connect</button>
                    <button class="ws-btn-danger" onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
                    <button class="ws-btn-secondary" onclick="clearMessages()">Clear</button>
                    <button class="ws-btn-secondary" onclick="sendTest()">Send Test</button>
                </div>

                <div class="ws-messages" id="messages"></div>

                <div class="ws-input-group">
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Type a message..."
                        disabled
                    />
                    <button class="ws-btn-primary" onclick="sendMessage()" id="sendBtn" disabled>Send</button>
                </div>

                <div class="ws-stats">
                    <div class="ws-stat">
                        <div class="ws-stat-label">Messages Sent</div>
                        <div class="ws-stat-value" id="sentCount">0</div>
                    </div>
                    <div class="ws-stat">
                        <div class="ws-stat-label">Messages Received</div>
                        <div class="ws-stat-value" id="receivedCount">0</div>
                    </div>
                    <div class="ws-stat">
                        <div class="ws-stat-label">Uptime</div>
                        <div class="ws-stat-value" id="uptime">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ws-card">
            <div class="ws-body">
                <div class="ws-info">
                    <h3>üì° WebSocket Chat Demo</h3>
                    <p><strong>Endpoint:</strong> <code>/ws/chat</code></p>
                    <p>This is a real-time WebSocket testing interface. Features:</p>
                    <ul>
                        <li>Connect/disconnect to WebSocket server</li>
                        <li>Send and receive messages in real-time</li>
                        <li>Broadcast messages to all connected clients</li>
                        <li>Track connection statistics</li>
                    </ul>
                    <p style="margin-top: 1rem;">
                        <a href="/pages/">‚Üê Back to Home</a> |
                        <a href="/docs">API Docs</a> |
                        <a href="/ws/test">Alternative Test Page</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let sentCount = 0;
        let receivedCount = 0;
        let startTime = null;
        let uptimeInterval = null;

        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }

        function addMessage(text, type = 'received') {
            const msg = document.createElement('div');
            msg.className = `ws-message ${type}`;

            const time = new Date().toLocaleTimeString();
            msg.innerHTML = `<div>${text}</div><div class="ws-message-time">${time}</div>`;

            document.getElementById('messages').appendChild(msg);
            msg.scrollIntoView({ behavior: 'smooth' });
        }

        function updateUptime() {
            if (startTime) {
                const seconds = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('uptime').textContent =
                    `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const url = `${protocol}//${location.host}/ws/chat`;

            ws = new WebSocket(url);

            ws.onopen = () => {
                updateStatus('Connected', true);
                addMessage('‚úì Connected to server', 'system');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;

                startTime = Date.now();
                uptimeInterval = setInterval(updateUptime, 1000);
            };

            ws.onmessage = (event) => {
                addMessage(event.data, 'received');
                receivedCount++;
                document.getElementById('receivedCount').textContent = receivedCount;
            };

            ws.onerror = () => {
                addMessage('‚úó Connection error', 'error');
            };

            ws.onclose = () => {
                updateStatus('Disconnected', false);
                addMessage('‚úó Disconnected from server', 'system');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                ws = null;

                if (uptimeInterval) {
                    clearInterval(uptimeInterval);
                    uptimeInterval = null;
                }
            };
        }

        function disconnect() {
            if (ws) ws.close();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();

            if (msg && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(msg);
                addMessage(`You: ${msg}`, 'sent');
                input.value = '';
                sentCount++;
                document.getElementById('sentCount').textContent = sentCount;
            }
        }

        function sendTest() {
            const messages = [
                'Hello, World!',
                'Testing WebSocket üöÄ',
                'Real-time messaging works!',
                'Broadcasting to all clients',
                'FastAPI + WebSocket = ‚ù§Ô∏è'
            ];
            document.getElementById('messageInput').value =
                messages[Math.floor(Math.random() * messages.length)];
            sendMessage();
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            sentCount = 0;
            receivedCount = 0;
            document.getElementById('sentCount').textContent = '0';
            document.getElementById('receivedCount').textContent = '0';
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
